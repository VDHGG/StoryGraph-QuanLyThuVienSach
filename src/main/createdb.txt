-- =============================================
-- ðŸ“š LIBRARY MANAGEMENT DATABASE â€“ FULL SCRIPT
-- âœ… FIXED ERROR #1067 (Timestamp default issue)
-- âœ… Compatible with MySQL + phpMyAdmin (XAMPP)
-- =============================================

-- 0ï¸âƒ£ Táº O DATABASE Má»šI
DROP DATABASE IF EXISTS storygraph_db;
CREATE DATABASE storygraph_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE storygraph_db;

-- 1ï¸âƒ£ USER
CREATE TABLE `User` (
    `Id` INT PRIMARY KEY AUTO_INCREMENT,
    `UserName` VARCHAR(100) NOT NULL UNIQUE,
    `Email` VARCHAR(255) NOT NULL UNIQUE,
    `PhoneNumber` BIGINT NULL,
    `Password` VARCHAR(255) NOT NULL,
    `Role` TINYINT NOT NULL DEFAULT 0 COMMENT '0=User, 1=Admin, 2=Librarian',
    `CreateTime` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_email (Email),
    INDEX idx_username (UserName)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2ï¸âƒ£ BOOK
CREATE TABLE `Book` (
    `Id` INT PRIMARY KEY AUTO_INCREMENT,
    `Title` VARCHAR(255) NOT NULL,
    `Description` TEXT NULL,
    `Image` VARCHAR(500) NULL,
    `Url` VARCHAR(500) NULL,
    `CreateTime` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `UpdateTime` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_title (Title),
    FULLTEXT INDEX idx_search (Title, Description)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 3ï¸âƒ£ AUTHOR
CREATE TABLE `Author` (
    `Id` INT PRIMARY KEY AUTO_INCREMENT,
    `Name` VARCHAR(255) NOT NULL,
    `Description` TEXT NULL,
    `Image` VARCHAR(500) NULL,
    INDEX idx_author_name (Name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 4ï¸âƒ£ CATEGORY
CREATE TABLE `Category` (
    `Id` INT PRIMARY KEY AUTO_INCREMENT,
    `Name` VARCHAR(100) NOT NULL UNIQUE,
    `Description` TEXT NULL,
    INDEX idx_category_name (Name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 5ï¸âƒ£ BOOKAUTHOR
CREATE TABLE `BookAuthor` (
    `BookId` INT NOT NULL,
    `AuthorId` INT NOT NULL,
    PRIMARY KEY (`BookId`, `AuthorId`),
    FOREIGN KEY (`BookId`) REFERENCES `Book`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (`AuthorId`) REFERENCES `Author`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 6ï¸âƒ£ BOOKCATEGORY
CREATE TABLE `BookCategory` (
    `BookId` INT NOT NULL,
    `CategoryId` INT NOT NULL,
    PRIMARY KEY (`BookId`, `CategoryId`),
    FOREIGN KEY (`BookId`) REFERENCES `Book`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (`CategoryId`) REFERENCES `Category`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 7ï¸âƒ£ BORROW â€“ ÄÃƒ Sá»¬A Lá»–I #1067
CREATE TABLE `Borrow` (
    `Id` INT PRIMARY KEY AUTO_INCREMENT,
    `BorrowDay` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `ExpireDay` TIMESTAMP NOT NULL DEFAULT '2038-01-19 03:14:07',  -- âœ… Há»£p lá»‡ vá»›i MySQL
    `ReturnDateTime` TIMESTAMP NULL,
    `UserId` INT NOT NULL,
    `BookId` INT NOT NULL,
    `Status` TINYINT NOT NULL DEFAULT 0 COMMENT '0=Äang mÆ°á»£n, 1=ÄÃ£ tráº£, 2=QuÃ¡ háº¡n',
    FOREIGN KEY (`UserId`) REFERENCES `User`(`Id`) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (`BookId`) REFERENCES `Book`(`Id`) ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_user_status (UserId, Status),
    INDEX idx_expire_status (ExpireDay, Status),
    INDEX idx_borrowday (BorrowDay)
) ENGINE=InnoDB;

-- ðŸ” TRIGGER: Tá»° Äá»˜NG TÃNH EXPIREDATE (+14 ngÃ y)
DELIMITER $$
CREATE TRIGGER trg_set_expire_day
BEFORE INSERT ON Borrow
FOR EACH ROW
BEGIN
    IF NEW.ExpireDay = '2038-01-19 03:14:07' THEN
        SET NEW.ExpireDay = DATE_ADD(NEW.BorrowDay, INTERVAL 14 DAY);
    END IF;
END$$
DELIMITER ;

-- 8ï¸âƒ£ REVIEW
CREATE TABLE `Review` (
    `Id` INT PRIMARY KEY AUTO_INCREMENT,
    `UserId` INT NOT NULL,
    `BookId` INT NOT NULL,
    `Rating` DECIMAL(3,2) CHECK (`Rating` >= 0 AND `Rating` <= 5),
    `Comment` TEXT NULL,
    `CreateTime` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (`UserId`) REFERENCES `User`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (`BookId`) REFERENCES `Book`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE,
    UNIQUE KEY uniq_user_book (`UserId`, `BookId`),
    INDEX idx_book_rating (BookId, Rating DESC)
) ENGINE=InnoDB;

-- 9ï¸âƒ£ SHELVES
CREATE TABLE `Shelves` (
    `Id` INT PRIMARY KEY AUTO_INCREMENT,
    `Name` VARCHAR(255) NOT NULL,
    `UserId` INT NOT NULL,
    `Description` TEXT NULL,
    `CreateTime` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (`UserId`) REFERENCES `User`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX idx_user_shelves (UserId)
) ENGINE=InnoDB;

-- ðŸ”Ÿ BOOKSHELVES
CREATE TABLE `BookShelves` (
    `ShelvesId` INT NOT NULL,
    `BookId` INT NOT NULL,
    PRIMARY KEY (`ShelvesId`, `BookId`),
    FOREIGN KEY (`ShelvesId`) REFERENCES `Shelves`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (`BookId`) REFERENCES `Book`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 11ï¸âƒ£ TOPRATE
CREATE TABLE `TopRate` (
    `UserId` INT NOT NULL,
    `BookId` INT NOT NULL,
    PRIMARY KEY (`UserId`, `BookId`),
    FOREIGN KEY (`UserId`) REFERENCES `User`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (`BookId`) REFERENCES `Book`(`Id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- ðŸ§© Dá»® LIá»†U MáºªU
INSERT INTO `User` (`UserName`, `Email`, `PhoneNumber`, `Password`, `Role`) VALUES
('admin', 'admin@library.com', 901234567, 'admin123', 1),
('john_doe', 'john@example.com', 901234568, 'user123', 0);

INSERT INTO `Category` (`Name`) VALUES
('Tiá»ƒu thuyáº¿t'),
('Khoa há»c'),
('Lá»‹ch sá»­');

INSERT INTO `Author` (`Name`) VALUES
('Nguyá»…n Nháº­t Ãnh'),
('Yuval Noah Harari');

INSERT INTO `Book` (`Title`, `Description`) VALUES
('Cho TÃ´i Xin Má»™t VÃ© Äi Tuá»•i ThÆ¡', 'Há»“i á»©c tuá»•i thÆ¡'),
('Sapiens', 'LÆ°á»£c sá»­ loÃ i ngÆ°á»i');

-- âœ… Káº¾T QUáº¢ XÃC NHáº¬N
SELECT 'âœ… DATABASE storygraph_db ÄÃƒ Táº O THÃ€NH CÃ”NG â€“ KHÃ”NG Lá»–I #1067!' AS Status;
